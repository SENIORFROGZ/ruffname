---
# FIXME: our current Gitlab version doesn't support importing a file more than once
# For now, the workaround is to include "common" files once in the top-level .gitlab-ci.yml file
# See: https://gitlab.com/gitlab-org/gitlab/-/issues/28987
# include:
#   - /.gitlab/docker_common/tag_job_templates.yml

#
# Image tagging & manifest publication
#

deploy-a7:
  extends: .docker_job_definition
  image: 486234852809.dkr.ecr.us-east-1.amazonaws.com/ci/datadog-agent-buildimages/deb_x64:$DATADOG_AGENT_BUILDIMAGES
  tags: ["runner:main", "size:2xlarge"]
  stage: deploy7
  dependencies: []
  script:
    - VERSION=$(inv -e agent.version --major-version 7 --url-safe)
    - | # If we're not deploying on tag 7, target the dev repo instead
      if [[ "$DEPLOY_AGENT" != "true" ]] || [[ "$RELEASE_VERSION_7" == "nightly-a7" ]] || [[ "$RELEASE_VERSION_7" == "" ]]; then
        REPOSITORY="${REPOSITORY}-dev"
      fi
    - echo "Working on repsoitory ${REPOSITORY}"
    - inv -e docker.publish-bulk ${SIGNING_ARGS} --platform linux/amd64 --src-template ${SRC_AGENT}:${SRC_TAG}-7-ARCH      --dst-template ${REPOSITORY}-ARCH:${VERSION}
    - inv -e docker.publish-bulk ${SIGNING_ARGS} --platform linux/amd64 --src-template ${SRC_AGENT}:${SRC_TAG}-7-jmx-ARCH  --dst-template ${REPOSITORY}-ARCH:${VERSION}-jmx

deploy_docker_hub_linux-a7:
  extends:
    - .docker_tag_job_definition
    - .deploy_docker_linux-a7
  rules:
    # TODO: Use in-rule variables instead of a condition in script once we reach Gitlab 13.8
    # - <<: *if_deploy_on_tag_7
    #   when: manual
    #   allow_failure: true
    #   variables:
    #     REPOSITORY: datadog/agent
    # - <<: *if_deploy_7
    #   when: manual
    #   allow_failure: true
    #   variables:
    #     REPOSITORY: datadog/agent-dev
    - <<: *if_deploy_7
      when: manual
      allow_failure: true
  variables:
    REPOSITORY: datadog/agent
    SIGNING_ARGS: --signed-push

deploy_google_container_registry_linux-a7:
  extends:
    - .google_container_registry_tag_job_definition
    - .deploy_docker_linux-a7
  rules:
    # TODO: Use in-rule variables instead of a condition in script once we reach Gitlab 13.8
    # - <<: *if_deploy_on_tag_7
    #   when: manual
    #   allow_failure: true
    #   variables:
    #     REPOSITORY: gcr.io/datadoghq/agent
    # - <<: *if_deploy_7
    #   when: manual
    #   allow_failure: true
    #   variables:
    #     REPOSITORY: gcr.io/datadoghq/agent-dev
    - <<: *if_deploy_7
      when: manual
      allow_failure: true
  variables:
    REPOSITORY: gcr.io/datadoghq/agent
    SIGNING_ARGS: ""

.deploy_docker-dogstatsd:
  stage: deploy7
  rules:
    !reference [.on_deploy_a7_manual]
  dependencies: []
  script:
    - VERSION=$(inv -e agent.version --major-version 7 --url-safe)
    - | # If we're not deploying on tag 7, target the dev repo instead
      if [[ "$DEPLOY_AGENT" != "true" ]] || [[ "$RELEASE_VERSION_7" == "nightly-a7" ]] || [[ "$RELEASE_VERSION_7" == "" ]]; then
        REPOSITORY="${REPOSITORY}-dev"
      fi
    - echo "Working on repsoitory ${REPOSITORY}"
    - inv -e docker.publish-manifest ${SIGNING_ARGS} --name ${REPOSITORY} --tag ${VERSION}
      --image ${REPOSITORY}-amd64:${VERSION},linux/amd64
    - inv -e docker.publish-manifest ${SIGNING_ARGS} --name ${REPOSITORY} --tag ${VERSION}-servercore
    - inv -e docker.publish-manifest ${SIGNING_ARGS} --name ${REPOSITORY} --tag ${VERSION}-jmx
      --image ${REPOSITORY}-amd64:${VERSION}-jmx,linux/amd64
    - inv -e docker.publish-manifest ${SIGNING_ARGS} --name ${REPOSITORY} --tag ${VERSION}-servercore-jmx


#
# Latest publication
#

deploy_latest-a7:
  extends: .docker_job_definition
  image: 486234852809.dkr.ecr.us-east-1.amazonaws.com/ci/datadog-agent-buildimages/deb_x64:$DATADOG_AGENT_BUILDIMAGES
  tags: ["runner:main", "size:2xlarge"]
  stage: deploy7
  dependencies: []
  script:
    - VERSION=$(inv -e agent.version --major-version 7 --url-safe)
    - | # If we're not deploying on tag 7, target the dev repo instead
      if [[ "$DEPLOY_AGENT" != "true" ]] || [[ "$RELEASE_VERSION_7" == "nightly-a7" ]] || [[ "$RELEASE_VERSION_7" == "" ]]; then
        REPOSITORY="${REPOSITORY}-dev"
      fi
    - echo "Working on repsoitory ${REPOSITORY}"
    # Manifests
    - inv -e docker.publish-manifest ${SIGNING_ARGS} --name ${REPOSITORY} --tag latest
      --image ${REPOSITORY}-amd64:${VERSION},linux/amd64
    - inv -e docker.publish-manifest ${SIGNING_ARGS} --name ${REPOSITORY} --tag latest-servercore
    - inv -e docker.publish-manifest ${SIGNING_ARGS} --name ${REPOSITORY} --tag latest-jmx
      --image ${REPOSITORY}-amd64:${VERSION}-jmx,linux/amd64
    - inv -e docker.publish-manifest ${SIGNING_ARGS} --name ${REPOSITORY} --tag latest-servercore-jmx
    - inv -e docker.publish-manifest ${SIGNING_ARGS} --name ${REPOSITORY} --tag 7
      --image ${REPOSITORY}-amd64:${VERSION},linux/amd64
    - inv -e docker.publish-manifest ${SIGNING_ARGS} --name ${REPOSITORY} --tag 7-servercore
    - inv -e docker.publish-manifest ${SIGNING_ARGS} --name ${REPOSITORY} --tag 7-jmx
      --image ${REPOSITORY}-amd64:${VERSION}-jmx,linux/amd64
    - inv -e docker.publish-manifest ${SIGNING_ARGS} --name ${REPOSITORY} --tag 7-servercore-jmx

deploy_latest_manifests_docker_hub-a7:
  extends:
    - .docker_tag_job_definition
    - .deploy_latest_manifests-a7
  rules:
    !reference [.on_deploy_a7_manual]
  dependencies: []
  script: # We can't use the 'trigger' keyword on manual jobs, otherwise they can't be run if the pipeline fails and is retried
    - python3 -m pip install -r requirements.txt
    - inv pipeline.trigger-child-pipeline --project-name "DataDog/public-images" --git-ref "main" --variables "IMG_REGISTRIES,IMG_SOURCES,IMG_DESTINATIONS"
  parallel:
    matrix:
      - IMG_SOURCES: ${SRC_AGENT}:v${CI_PIPELINE_ID}-${CI_COMMIT_SHORT_SHA}-7-amd64,${SRC_AGENT}:v${CI_PIPELINE_ID}-${CI_COMMIT_SHORT_SHA}-7-arm64,${SRC_AGENT}:v${CI_PIPELINE_ID}-${CI_COMMIT_SHORT_SHA}-7-win1809-amd64,${SRC_AGENT}:v${CI_PIPELINE_ID}-${CI_COMMIT_SHORT_SHA}-7-win1909-amd64,${SRC_AGENT}:v${CI_PIPELINE_ID}-${CI_COMMIT_SHORT_SHA}-7-win2004-amd64
        IMG_DESTINATIONS: ${AGENT_REPOSITORY}:7,${AGENT_REPOSITORY}:latest
      - IMG_SOURCES: ${SRC_AGENT}:v${CI_PIPELINE_ID}-${CI_COMMIT_SHORT_SHA}-7-jmx-amd64,${SRC_AGENT}:v${CI_PIPELINE_ID}-${CI_COMMIT_SHORT_SHA}-7-jmx-arm64,${SRC_AGENT}:v${CI_PIPELINE_ID}-${CI_COMMIT_SHORT_SHA}-7-jmx-win1809-amd64,${SRC_AGENT}:v${CI_PIPELINE_ID}-${CI_COMMIT_SHORT_SHA}-7-jmx-win1909-amd64,${SRC_AGENT}:v${CI_PIPELINE_ID}-${CI_COMMIT_SHORT_SHA}-7-jmx-win2004-amd64
        IMG_DESTINATIONS: ${AGENT_REPOSITORY}:7-jmx,${AGENT_REPOSITORY}:latest-jmx
      - IMG_SOURCES: ${SRC_AGENT}:v${CI_PIPELINE_ID}-${CI_COMMIT_SHORT_SHA}-7-win1809-servercore-amd64,${SRC_AGENT}:v${CI_PIPELINE_ID}-${CI_COMMIT_SHORT_SHA}-7-win1909-servercore-amd64,${SRC_AGENT}:v${CI_PIPELINE_ID}-${CI_COMMIT_SHORT_SHA}-7-win2004-servercore-amd64
        IMG_DESTINATIONS: ${AGENT_REPOSITORY}:7-servercore,${AGENT_REPOSITORY}:latest-servercore
      - IMG_SOURCES: ${SRC_AGENT}:v${CI_PIPELINE_ID}-${CI_COMMIT_SHORT_SHA}-7-jmx-win1809-servercore-amd64,${SRC_AGENT}:v${CI_PIPELINE_ID}-${CI_COMMIT_SHORT_SHA}-7-jmx-win1909-servercore-amd64,${SRC_AGENT}:v${CI_PIPELINE_ID}-${CI_COMMIT_SHORT_SHA}-7-jmx-win2004-servercore-amd64
        IMG_DESTINATIONS: ${AGENT_REPOSITORY}:7-servercore-jmx,${AGENT_REPOSITORY}:latest-servercore-jmx

deploy_latest-dogstatsd:
  extends: .docker_job_definition
  image: 486234852809.dkr.ecr.us-east-1.amazonaws.com/ci/datadog-agent-buildimages/deb_x64:$DATADOG_AGENT_BUILDIMAGES
  tags: ["runner:main", "size:2xlarge"]
  stage: deploy7
  rules:
    !reference [.on_deploy_a7_manual]
  dependencies: []
  script: # We can't use the 'trigger' keyword on manual jobs, otherwise they can't be run if the pipeline fails and is retried
    - python3 -m pip install -r requirements.txt
    - inv pipeline.trigger-child-pipeline --project-name "DataDog/public-images" --git-ref "main" --variables "IMG_REGISTRIES,IMG_SOURCES,IMG_DESTINATIONS"
  variables:
    IMG_SOURCES: ${SRC_DSD}:v${CI_PIPELINE_ID}-${CI_COMMIT_SHORT_SHA}-amd64
    IMG_DESTINATIONS: ${DSD_REPOSITORY}:7,${DSD_REPOSITORY}:latest
