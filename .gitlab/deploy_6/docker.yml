---
# FIXME: our current Gitlab version doesn't support importing a file more than once
# For now, the workaround is to include "common" files once in the top-level .gitlab-ci.yml file
# See: https://gitlab.com/gitlab-org/gitlab/-/issues/28987
# include:
#   - /.gitlab/docker_common/tag_job_templates.yml

#
# Image tagging & manifest publication
#

deploy-a6:
  extends: .docker_job_definition
  stage: deploy6
  rules:
    !reference [.on_deploy_a6_manual]
  trigger:
    project: DataDog/public-images
    branch: main
    strategy: depend
  parallel:
    matrix:
      - IMG_SOURCES: ${SRC_AGENT}:v$CI_PIPELINE_ID-${CI_COMMIT_SHORT_SHA}-6-amd64,${SRC_AGENT}:v$CI_PIPELINE_ID-${CI_COMMIT_SHORT_SHA}-6-arm64
        IMG_DESTINATIONS: ${AGENT_REPOSITORY}:${VERSION}
      - IMG_SOURCES: ${SRC_AGENT}:v$CI_PIPELINE_ID-${CI_COMMIT_SHORT_SHA}-6-jmx-amd64,${SRC_AGENT}:v$CI_PIPELINE_ID-${CI_COMMIT_SHORT_SHA}-6-jmx-arm64
        IMG_DESTINATIONS: ${AGENT_REPOSITORY}:${VERSION}-jmx


#
# Latest publication
#

deploy_latest-a6:
  extends: .docker_job_definition
  stage: deploy6
  rules:
    !reference [.on_deploy_a6_manual]
  trigger:
    project: DataDog/public-images
    branch: main
    strategy: depend
  parallel:
    matrix:
      - IMG_SOURCES: ${SRC_AGENT}:v$CI_PIPELINE_ID-${CI_COMMIT_SHORT_SHA}-6-amd64,${SRC_AGENT}:v$CI_PIPELINE_ID-${CI_COMMIT_SHORT_SHA}-6-arm64
        IMG_DESTINATIONS: ${AGENT_REPOSITORY}:6,${REPOSITORY}:latest-py2
      - IMG_SOURCES: ${SRC_AGENT}:v$CI_PIPELINE_ID-${CI_COMMIT_SHORT_SHA}-6-jmx-amd64,${SRC_AGENT}:v$CI_PIPELINE_ID-${CI_COMMIT_SHORT_SHA}-6-jmx-arm64
        IMG_DESTINATIONS: ${AGENT_REPOSITORY}:6-jmx,${REPOSITORY}:latest-py2-jmx
